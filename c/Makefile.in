SHELL = /bin/sh
VPATH = @srcdir@
 
top_srcdir = @top_srcdir@
srcdir = @srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = $(exec_prefix)/bin
infodir = $(prefix)/info
libdir = $(prefix)/lib/gnudl
mandir = $(prefix)/man/man1
CFLAGS = $(CPPFLAGS) @CFLAGS@ @ELF_CFLAGS@
ERL_INTERFACE=${ERLDIR}/lib/${ERL_INTERFACE}
INC_LIBS = -lerl_interface -lei -lcap -lstdc++
EXECUTABLE = ../priv/bin/babysitter

ifeq ($(shell uname),Linux)
	ARCH = linux
	LDFLAGS = $(LDFLAGS_COMMON) -shared
else
	ARCH = macosx
	LDFLAGS = $(LDFLAGS_COMMON) -dynamic -bundle -undefined suppress -flat_namespace
endif

# Defines
CC = g++
CPPFLAGS = @CPPFLAGS@
LIBS = @LIBS@
TEST_SOURCES := $(wildcard check_*.cpp)
TEST_OBJECTS := $(patsubst %.cpp,%.o,$(TEST_SOURCES))
UNDER_TEST := $(patsubst check_%.cpp,%.o,$(TEST_SOURCES))
PACKAGE_NAME = @PACKAGE_NAME@
PACKAGE_VERSION = @PACKAGE_VERSION@

INTERMEDIATES = $(patsubst %.cpp, %.o, $(wildcard *.cpp))
OUTPUTFILES := $(INTERMEDIATES) babysitter
 
DEFS = -DHAVE_CONFIG_H
 
ERLDIR = @ERLDIR@
 
all: honeycomb $(OUTPUTFILES)
 
debug:
	$(MAKE) DEBUG=-DDEBUG
 
.SUFFIXES: .o .cpp .h
  
test_suite: suite.o $(TEST_OBJECTS) $(UNDER_TEST)
	$(CC) $(CFLAGS) $(DEFS) $(DEBUG) -lcheck -o $@ $^ @LIBEI@	
 
test: test_suite
	$(MAKE) TEST=-DTEST
	./test_suite
 
test-dbg: test_suite
	$(MAKE) TEST=-DTEST
	gdb test_suite
 
test_%.o: test_%.c %.o
	$(CC) $(CFLAGS) $(DEFS) $(DEBUG) -c $<

.cpp.o:
	$(CC) $(CFLAGS) $(DEFS) $(DEBUG) -c $<

honeycomb: honeycomb.cpp honeycomb.h
	$(CC) $(CFLAGS) $(DEFS) $(DEBUG) -c honeycomb.cpp

babysitter: configuration.h
	mkdir -p `dirname $(EXECUTABLE)`
	$(CC) $(CFLAGS) $(DEFS) $(DEBUG) -o $(EXECUTABLE) $(INTERMEDIATES) $(INC_LIBS)

configuration.h:
	sh configuration.sh > configuration.h

clean:
	rm -rf *.o *.a $(OUTPUTFILES) $(EXECUTABLE)
 
install:
	install -d $(ERLDIR)/lib/$(PACKAGE_NAME)-$(PACKAGE_VERSION)/priv
	cp -r `pwd`/../priv $(ERLDIR)/lib/$(PACKAGE_NAME)-$(PACKAGE_VERSION)/
 
package:
	install -d `pwd`/../.pkgtmp/$(PACKAGE_NAME)-$(PACKAGE_VERSION)/priv
	cp -r `pwd`/../priv/* `pwd`/../.pkgtmp/$(PACKAGE_NAME)-$(PACKAGE_VERSION)/priv